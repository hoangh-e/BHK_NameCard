Screens:
  EmployeeDashboardScreen:
    Properties:
      Fill: =Colors.BackgroundLight
      OnVisible: |
        =// Load SharePoint data first - prioritize over demo data
        Set(varLoadingRequests, true);
        
        // Try to load from SharePoint NamecardRequest_1 table
        IfError(
          ClearCollect(colNameCardRequests, 
            Filter(NamecardRequest_1, 
              userID = varCurrentEmployee.userID
            )
          ),
          // Fallback to demo data if SharePoint unavailable
          ClearCollect(colNameCardRequests,
            {requestID: 1, userID: "U001", quantity: 1, suggestedReason: "Th·∫ª t√™n cho tr∆∞·ªüng ph√≤ng m·ªõi", 
             note: "Th·∫ª t√™n executive cho s·ª± ki·ªán quan tr·ªçng", status: "ƒê√£ duy·ªát", printNote: "ƒê√£ in"},
            {requestID: 2, userID: "U001", quantity: 1, suggestedReason: "Th·∫ª t√™n executive cho s·ª± ki·ªán quan tr·ªçng", 
             note: "C·∫ßn in g·∫•p", status: "Ch·ªù duy·ªát", printNote: ""},
            {requestID: 3, userID: "U001", quantity: 2, suggestedReason: "Th·∫ª t·∫°m th·ªùi cho d·ª± √°n", 
             note: "D·ª± √°n k√©o d√†i 3 th√°ng", status: "T·ª´ ch·ªëi", printNote: ""}
          );
          Notify("ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu demo - kh√¥ng th·ªÉ k·∫øt n·ªëi SharePoint", NotificationType.Warning)
        );
        
        Set(varCurrentEmployee, {userID: "U001", fullname: "Nguy·ªÖn VƒÉn An", departmentID: 1});
        Set(varShowRequestForm, false);
        Set(varFormMode, "Create");
        Set(varEditingRequest, Blank());
        Set(varSelectedRequest, Blank());
        Set(varShowRequestDetails, false);
        Set(varFilterStatus, "All");
        Set(varSearchText, "");
        Set(varShowContextMenu, false);
        Set(varContextMenuX, 0);
        Set(varContextMenuY, 0);
        Set(varLoadingRequests, false);
        
        UpdateContext({
          statsData: {
            TotalRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID)),
            PendingRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "Ch·ªù duy·ªát")),
            ApprovedRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "ƒê√£ duy·ªát")),
            RejectedRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "T·ª´ ch·ªëi"))
          }
        })
    Children:
      - Main.Content.Container_1:
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            Fill: =Colors.BackgroundLight
            Height: =Parent.Height - Styles.Header.Height
            Width: =Parent.Width - Styles.Navigation.Width
            X: =Styles.Navigation.Width
            Y: =Styles.Header.Height
          Children:
            - Page.Header.Section_1:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.White
                  Height: =Parent.Height * 0.12
                  Width: =Parent.Width
                Children:
                  - Page.Title_1:
                      Control: Label
                      Properties:
                        Color: =Colors.TextPrimary
                        FontWeight: =FontWeight.Bold
                        Height: =Parent.Height * 0.35
                        Size: =FontSizes.XLarge
                        Text: ="Dashboard nh√¢n vi√™n"
                        Width: =Parent.Width * 0.5
                        X: =Parent.Width * 0.03
                        Y: =Parent.Height * 0.15
                  - Page.Subtitle_1:
                      Control: Label
                      Properties:
                        Color: =Colors.TextMuted
                        Height: =Parent.Height * 0.35
                        Size: =FontSizes.Base
                        Text: =Concatenate("Xin ch√†o, ", varCurrentEmployee.fullname)
                        Width: =Parent.Width * 0.5
                        X: =Parent.Width * 0.03
                        Y: =Parent.Height * 0.5
                  - Create.Request.Button:
                      Control: Classic/Button
                      Properties:
                        BorderColor: =If(varLoadingRequests, Colors.PrimaryLight, Colors.Primary)
                        BorderThickness: =If(varLoadingRequests, 2, 1)
                        Color: =Styles.Button.Primary.Color
                        DisplayMode: =If(varLoadingRequests, DisplayMode.Disabled, DisplayMode.Edit)
                        Fill: =If(varLoadingRequests, ColorFade(Styles.Button.Primary.Fill, 30%), Styles.Button.Primary.Fill)
                        Height: =Styles.Button.Height
                        HoverFill: =If(varLoadingRequests, Styles.Button.Primary.Fill, ColorFade(Styles.Button.Primary.HoverFill, -5%))
                        OnSelect: |
                          =Set(varLoadingRequests, true);
                          Set(varFormMode, "Create");
                          Set(varEditingRequest, Blank());
                          Set(varLoadingRequests, false);
                          Set(varShowRequestForm, true)
                        PressedFill: =ColorFade(Styles.Button.Primary.Fill, -10%)
                        Size: =FontSizes.Medium
                        Text: =If(varLoadingRequests, LoadingStates.Button.Text, "+ T·∫°o y√™u c·∫ßu th·∫ª t√™n")
                        Width: =Parent.Width * 0.25
                        X: =Parent.Width - Parent.Width * 0.28
                        Y: =Parent.Height * 0.2
            - Stats.Cards.Section:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.BackgroundLight
                  Height: =Parent.Height * 0.18
                  Width: =Parent.Width
                  Y: =Parent.Height * 0.12
                Children:
                  - Total.Requests.Card_1:
                      Control: CanvasComponent
                      ComponentName: StatsCardComponent
                      Properties:
                        BorderColor: =Colors.Primary
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height * 0.8
                        IsClickable: =true
                        IsLoading: =false
                        Title: ="T·ªïng y√™u c·∫ßu"
                        Value: =Text(statsData.TotalRequests)
                        ValueColor: =Colors.Primary
                        Width: =Parent.Width * 0.22
                        X: =Parent.Width * 0.03
                        Y: =Parent.Height * 0.1
                  - Pending.Requests.Card:
                      Control: CanvasComponent
                      ComponentName: StatsCardComponent
                      Properties:
                        BorderColor: =Colors.Warning
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height * 0.8
                        IsClickable: =true
                        IsLoading: =false
                        Title: ="Ch·ªù duy·ªát"
                        Value: =Text(statsData.PendingRequests)
                        ValueColor: =Colors.Warning
                        Width: =Parent.Width * 0.22
                        X: =Parent.Width * 0.27
                        Y: =Parent.Height * 0.1
                  - Approved.Requests.Card_1:
                      Control: CanvasComponent
                      ComponentName: StatsCardComponent
                      Properties:
                        BorderColor: =Colors.Success
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height * 0.8
                        IsClickable: =true
                        IsLoading: =false
                        Title: ="ƒê√£ duy·ªát"
                        Value: =Text(statsData.ApprovedRequests)
                        ValueColor: =Colors.Success
                        Width: =Parent.Width * 0.22
                        X: =Parent.Width * 0.51
                        Y: =Parent.Height * 0.1
                  - Rejected.Requests.Card_1:
                      Control: CanvasComponent
                      ComponentName: StatsCardComponent
                      Properties:
                        BorderColor: =Colors.Error
                        Fill: =RGBA(255, 255, 255, 1)
                        Height: =Parent.Height * 0.8
                        IsClickable: =true
                        IsLoading: =false
                        Title: ="B·ªã t·ª´ ch·ªëi"
                        Value: =Text(statsData.RejectedRequests)
                        ValueColor: =Colors.Error
                        Width: =Parent.Width * 0.22
                        X: =Parent.Width * 0.75
                        Y: =Parent.Height * 0.1
            - Requests.List.Section:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.BackgroundLight
                  Height: =Parent.Height * 0.7
                  Width: =Parent.Width
                  Y: =Parent.Height * 0.3
                Children:
                  - Filter.Search.Bar:
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        Fill: =Colors.White
                        Height: =Parent.Height * 0.1
                        Width: =Parent.Width * 0.94
                        X: =Parent.Width * 0.03
                        Y: =Parent.Height * 0.02
                      Children:
                        - Section.Title:
                            Control: Label
                            Properties:
                              Color: =Colors.TextPrimary
                              FontWeight: =FontWeight.Bold
                              Height: =Parent.Height * 0.4
                              Size: =FontSizes.Large
                              Text: ="Danh s√°ch y√™u c·∫ßu th·∫ª t√™n"
                              Width: =Parent.Width * 0.3
                              X: =Parent.Width * 0.02
                              Y: =Parent.Height * 0.1
                        - Status.Filter_1:
                            Control: Classic/DropDown
                            Properties:
                              BorderColor: =Colors.Border
                              Default: ="T·∫•t c·∫£"
                              Fill: =Colors.White
                              Height: =Styles.Input.Height
                              Items: |
                                =Table(
                                {Value: "All", Text: "T·∫•t c·∫£"},
                                {Value: "Ch·ªù duy·ªát", Text: "Ch·ªù duy·ªát"},
                                {Value: "ƒê√£ duy·ªát", Text: "ƒê√£ duy·ªát"},
                                {Value: "T·ª´ ch·ªëi", Text: "T·ª´ ch·ªëi"},
                                {Value: "ƒê√£ in", Text: "ƒê√£ in"},
                                {Value: "ƒê√£ ph√°t", Text: "ƒê√£ ph√°t"}
                                )
                              OnChange: |
                                =Set(varFilterStatus, Self.Selected.Result.Value)
                              Width: =Parent.Width * 0.2
                              X: =Parent.Width * 0.45
                              Y: =Parent.Height * 0.25
                        - Search.Input:
                            Control: Classic/TextInput
                            Properties:
                              BorderColor: =Colors.Border
                              Color: =Colors.TextPrimary
                              Default: =""
                              Fill: =Colors.White
                              FocusedBorderColor: =Colors.Primary
                              Height: =Styles.Input.Height
                              HintText: ="T√¨m ki·∫øm theo ghi ch√∫..."
                              OnChange: |
                                =Set(varSearchText, Self.Text)
                              Size: =FontSizes.Base
                              Width: =Parent.Width * 0.3
                              X: =Parent.Width * 0.68
                              Y: =Parent.Height * 0.25
                  - Requests.Data.Container:
                      Control: GroupContainer
                      Variant: ManualLayout
                      Properties:
                        Fill: =Colors.White
                        Height: =Parent.Height * 0.84
                        Width: =Parent.Width * 0.94
                        X: =Parent.Width * 0.03
                        Y: =Parent.Height * 0.14
                      Children:
                        - Requests.DataTable:
                            Control: DataTable
                            Properties:
                              BorderColor: =RGBA(0, 0, 0, 0)
                              Color: =RGBA(50, 49, 48, 1)
                              Fill: =RGBA(255, 255, 255, 1)
                              Font: =Font.'Segoe UI'
                              HeadingColor: =RGBA(255, 255, 255, 1)
                              HeadingFill: =RGBA(0, 120, 212, 1)
                              HeadingFont: =Font.'Segoe UI'
                              Height: =Parent.Height
                              Items: |
                                =Filter(colNameCardRequests, 
                                  And(
                                    userID = varCurrentEmployee.userID,
                                    Or(varFilterStatus = "All", status = varFilterStatus),
                                    Or(IsBlank(varSearchText), varSearchText = "", note Like "*" & varSearchText & "*")
                                  )
                                )
                              Size: =13
                              Width: =Parent.Width
                            Children:
                              - RequestID.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="M√£ YC"
                                    FieldName: ="requestID"
                                    Order: =1
                                    Text: =Concatenate("YC-", Text(ThisItem.requestID, "000"))
                                    Width: =90
                              - Quantity.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="S·ªë l∆∞·ª£ng"
                                    FieldName: ="quantity"
                                    Order: =2
                                    Text: =Text(ThisItem.quantity)
                                    Width: =80
                              - SuggestedReason.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="L√Ω do c·∫•p"
                                    FieldName: ="suggestedReason"
                                    Order: =3
                                    Text: =Left(ThisItem.suggestedReason, 40) & If(Len(ThisItem.suggestedReason) > 40, "...", "")
                                    Width: =200
                              - Status.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="Tr·∫°ng th√°i"
                                    FieldName: ="status"
                                    Order: =4
                                    Text: =ThisItem.status
                                    Width: =120
                              - Note.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="Ghi ch√∫"
                                    FieldName: ="note"
                                    Order: =5
                                    Text: =Left(Coalesce(ThisItem.note, ""), 50) & If(Len(Coalesce(ThisItem.note, "")) > 50, "...", "")
                                    Width: =200
                              - PrintNote.Column:
                                  Control: DataTableColumn
                                  Variant: Textual
                                  Properties:
                                    FieldDisplayName: ="Ghi ch√∫ in"
                                    FieldName: ="printNote"
                                    Order: =6
                                    Text: =Left(Coalesce(ThisItem.printNote, ""), 30) & If(Len(Coalesce(ThisItem.printNote, "")) > 30, "...", "")
                                    Width: =150
                        - DataTable.Selection.Handler:
                            Control: Rectangle
                            Properties:
                              Fill: =RGBA(0, 0, 0, 0)
                              Height: ='Requests.DataTable'.Height
                              OnSelect: |
                                =If(Not(IsBlank('Requests.DataTable'.Selected)),
                                    Set(varSelectedRequest, 'Requests.DataTable'.Selected);
                                    Set(varContextMenuX, 200);
                                    Set(varContextMenuY, 300);
                                    Set(varShowContextMenu, true)
                                )
                              Width: ='Requests.DataTable'.Width
                              X: ='Requests.DataTable'.X
                              Y: ='Requests.DataTable'.Y
                        - Request.Context.Menu:
                            Control: GroupContainer
                            Variant: ManualLayout
                            Properties:
                              BorderColor: =Colors.Border
                              BorderThickness: =1
                              Fill: =Colors.White
                              Height: =120
                              Visible: =varShowContextMenu
                              Width: =150
                              X: =varContextMenuX
                              Y: =varContextMenuY
                            Children:
                              - View.Context.Button:
                                  Control: Classic/Button
                                  Properties:
                                    BorderColor: =RGBA(0, 0, 0, 0)
                                    Color: =Colors.TextPrimary
                                    Fill: =RGBA(0, 0, 0, 0)
                                    HoverFill: =Colors.BackgroundLight
                                    OnSelect: |
                                      =Set(varShowRequestDetails, true);
                                      Set(varShowContextMenu, false)
                                    Size: =FontSizes.Base
                                    Text: ="üëÅ Xem chi ti·∫øt"
                                    Width: =Parent.Width
                              - Edit.Context.Button:
                                  Control: Classic/Button
                                  Properties:
                                    BorderColor: =RGBA(0, 0, 0, 0)
                                    Color: =Colors.TextPrimary
                                    DisplayMode: |
                                      =If(varSelectedRequest.status = "Ch·ªù duy·ªát", DisplayMode.Edit, DisplayMode.Disabled)
                                    Fill: =RGBA(0, 0, 0, 0)
                                    HoverFill: =Colors.BackgroundLight
                                    OnSelect: |
                                      =Set(varFormMode, "Edit");
                                      Set(varEditingRequest, varSelectedRequest);
                                      Set(varShowRequestForm, true);
                                      Set(varShowContextMenu, false)
                                    Size: =FontSizes.Base
                                    Text: ="‚úé Ch·ªânh s·ª≠a"
                                    Width: =Parent.Width
                                    Y: =40
      - Context.Menu.Overlay:
          Control: Rectangle
          Properties:
            Fill: =RGBA(0, 0, 0, 0)
            Height: =Parent.Height
            OnSelect: |
              =Set(varShowContextMenu, false)
            Visible: =varShowContextMenu
            Width: =Parent.Width
      - Request.Form.Modal.Overlay:
          Control: Rectangle
          Properties:
            Fill: =Styles.Modal.Overlay
            Height: =Parent.Height
            OnSelect: |
              =Set(varShowRequestForm, false)
            Visible: =varShowRequestForm
            Width: =Parent.Width
      - Request.Form.Modal:
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            Fill: =Colors.White
            Height: =Parent.Height * 0.8
            Visible: =varShowRequestForm
            Width: =Parent.Width * 0.6
            X: =If(varShowRequestForm, (Parent.Width - Parent.Width * 0.6) / 2, -Parent.Width)
            Y: =If(varShowRequestForm, (Parent.Height - Parent.Height * 0.8) / 2, -Parent.Height)
          Children:
            - Modal.Header:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.Primary
                  Height: =Parent.Height * 0.1
                  Width: =Parent.Width
                Children:
                  - Modal.Title:
                      Control: Label
                      Properties:
                        Color: =Colors.White
                        FontWeight: =FontWeight.Bold
                        Height: =Parent.Height
                        Size: =FontSizes.Large
                        Text: =If(varFormMode = "Create", "T·∫°o y√™u c·∫ßu th·∫ª t√™n m·ªõi", "Ch·ªânh s·ª≠a y√™u c·∫ßu th·∫ª t√™n")
                        Width: =Parent.Width * 0.8
                        X: =Parent.Width * 0.04
                  - Modal.Close.Button:
                      Control: Classic/Button
                      Properties:
                        BorderColor: =Colors.White
                        Color: =Colors.White
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =Parent.Height * 0.6
                        OnSelect: |
                          =Set(varShowRequestForm, false)
                        Size: =FontSizes.Large
                        Text: ="√ó"
                        Width: =Parent.Height * 0.6
                        X: =Parent.Width * 0.9
                        Y: =Parent.Height * 0.2
            - Form.Content:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.White
                  Height: =Parent.Height * 0.8
                  Width: =Parent.Width
                  Y: =Parent.Height * 0.1
                Children:
                  - Quantity.Label:
                      Control: Label
                      Properties:
                        Color: =Colors.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =Parent.Height * 0.08
                        Size: =FontSizes.Medium
                        Text: ="S·ªë l∆∞·ª£ng *"
                        Width: =Parent.Width * 0.4
                        X: =Parent.Width * 0.05
                        Y: =Parent.Height * 0.05
                  - Quantity.Input:
                      Control: Classic/TextInput
                      Properties:
                        BorderColor: =Colors.Border
                        Color: =Colors.TextPrimary
                        Default: =If(varFormMode = "Edit", Text(varEditingRequest.quantity), "1")
                        Fill: =Colors.White
                        FocusedBorderColor: =Colors.Primary
                        Format: =TextFormat.Number
                        Height: =Styles.Input.Height
                        HintText: ="Nh·∫≠p s·ªë l∆∞·ª£ng th·∫ª c·∫ßn c·∫•p"
                        Size: =FontSizes.Base
                        Width: =Parent.Width * 0.4
                        X: =Parent.Width * 0.05
                        Y: =Parent.Height * 0.13
                  - SuggestedReason.Label:
                      Control: Label
                      Properties:
                        Color: =Colors.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =Parent.Height * 0.08
                        Size: =FontSizes.Medium
                        Text: ="L√Ω do c·∫•p *"
                        Width: =Parent.Width * 0.4
                        X: =Parent.Width * 0.55
                        Y: =Parent.Height * 0.05
                  - SuggestedReason.Input:
                      Control: Classic/TextInput
                      Properties:
                        BorderColor: =Colors.Border
                        Color: =Colors.TextPrimary
                        Default: =If(varFormMode = "Edit", varEditingRequest.suggestedReason, "")
                        Fill: =Colors.White
                        FocusedBorderColor: =Colors.Primary
                        Height: =Styles.Input.Height
                        HintText: ="Nh·∫≠p l√Ω do c·∫•p th·∫ª t√™n"
                        Size: =FontSizes.Base
                        Width: =Parent.Width * 0.4
                        X: =Parent.Width * 0.55
                        Y: =Parent.Height * 0.13
                  - Notes.Label:
                      Control: Label
                      Properties:
                        Color: =Colors.TextPrimary
                        FontWeight: =FontWeight.Semibold
                        Height: =Parent.Height * 0.08
                        Size: =FontSizes.Medium
                        Text: ="Ghi ch√∫"
                        Width: =Parent.Width * 0.9
                        X: =Parent.Width * 0.05
                        Y: =Parent.Height * 0.25
                  - Notes.Input:
                      Control: Classic/TextInput
                      Properties:
                        BorderColor: =Colors.Border
                        Color: =Colors.TextPrimary
                        Default: =If(varFormMode = "Edit", Coalesce(varEditingRequest.note, ""), "")
                        Fill: =Colors.White
                        FocusedBorderColor: =Colors.Primary
                        Height: =Parent.Height * 0.15
                        HintText: ="Nh·∫≠p ghi ch√∫ ho·∫∑c y√™u c·∫ßu ƒë·∫∑c bi·ªát..."
                        Mode: =TextMode.MultiLine
                        Size: =FontSizes.Base
                        Width: =Parent.Width * 0.9
                        X: =Parent.Width * 0.05
                        Y: =Parent.Height * 0.33
            - Form.Footer:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.BackgroundLight
                  Height: =Parent.Height * 0.1
                  Width: =Parent.Width
                  Y: =Parent.Height * 0.9
                Children:
                  - Cancel.Button:
                      Control: Classic/Button
                      Properties:
                        BorderColor: =Colors.Border
                        Color: =Styles.Button.Secondary.Color
                        Fill: =Styles.Button.Secondary.Fill
                        Height: =Styles.Button.Height
                        HoverFill: =Styles.Button.Secondary.HoverFill
                        OnSelect: |
                          =Set(varShowRequestForm, false)
                        Size: =FontSizes.Medium
                        Text: ="H·ªßy"
                        Width: =Parent.Width * 0.15
                        X: =Parent.Width * 0.6
                        Y: =Parent.Height * 0.2
                  - Save.Button:
                      Control: Classic/Button
                      Properties:
                        BorderColor: =Colors.Primary
                        Color: =Styles.Button.Primary.Color
                        DisplayMode: |
                          =If(And(Not(IsBlank('Quantity.Input'.Text)), Value('Quantity.Input'.Text) > 0, Not(IsBlank('SuggestedReason.Input'.Text))), DisplayMode.Edit, DisplayMode.Disabled)
                        Fill: =Styles.Button.Primary.Fill
                        Height: =Styles.Button.Height
                        HoverFill: =Styles.Button.Primary.HoverFill
                        OnSelect: |
                          =Set(varLoadingRequests, true);
                          
                          If(varFormMode = "Create",
                            // CREATE - Try SharePoint first, fallback to collection
                            IfError(
                              Patch(NamecardRequest_1, Defaults(NamecardRequest_1), {
                                userID: varCurrentEmployee.userID,
                                quantity: Value('Quantity.Input'.Text),
                                suggestedReason: 'SuggestedReason.Input'.Text,
                                note: 'Notes.Input'.Text,
                                status: "Ch·ªù duy·ªát",
                                printNote: ""
                              });
                              // Refresh collection from SharePoint
                              ClearCollect(colNameCardRequests, 
                                Filter(NamecardRequest_1, userID = varCurrentEmployee.userID)
                              ),
                              // Fallback to collection if SharePoint fails
                              Collect(colNameCardRequests, {
                                requestID: Max(colNameCardRequests, requestID) + 1,
                                userID: varCurrentEmployee.userID,
                                quantity: Value('Quantity.Input'.Text),
                                suggestedReason: 'SuggestedReason.Input'.Text,
                                note: 'Notes.Input'.Text,
                                status: "Ch·ªù duy·ªát",
                                printNote: ""
                              });
                              Notify("L∆∞u offline - s·∫Ω ƒë·ªìng b·ªô khi c√≥ k·∫øt n·ªëi", NotificationType.Warning)
                            ),
                            // EDIT - Try SharePoint first, fallback to collection
                            IfError(
                              Patch(NamecardRequest_1, 
                                LookUp(NamecardRequest_1, requestID = varEditingRequest.requestID), {
                                  quantity: Value('Quantity.Input'.Text),
                                  suggestedReason: 'SuggestedReason.Input'.Text,
                                  note: 'Notes.Input'.Text
                                }
                              );
                              // Refresh collection from SharePoint
                              ClearCollect(colNameCardRequests, 
                                Filter(NamecardRequest_1, userID = varCurrentEmployee.userID)
                              ),
                              // Fallback to collection update
                              UpdateIf(colNameCardRequests, requestID = varEditingRequest.requestID, {
                                quantity: Value('Quantity.Input'.Text),
                                suggestedReason: 'SuggestedReason.Input'.Text,
                                note: 'Notes.Input'.Text
                              });
                              Notify("C·∫≠p nh·∫≠t offline - s·∫Ω ƒë·ªìng b·ªô khi c√≥ k·∫øt n·ªëi", NotificationType.Warning)
                            )
                          );
                          
                          Set(varShowRequestForm, false);
                          Set(varLoadingRequests, false);
                          
                          UpdateContext({
                            statsData: {
                              TotalRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID)),
                              PendingRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "Ch·ªù duy·ªát")),
                              ApprovedRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "ƒê√£ duy·ªát")),
                              RejectedRequests: CountRows(Filter(colNameCardRequests, userID = varCurrentEmployee.userID && status = "T·ª´ ch·ªëi"))
                            }
                          });
                          
                          Notify(If(varFormMode = "Create", "ƒê√£ t·∫°o y√™u c·∫ßu th·∫ª t√™n th√†nh c√¥ng!", "ƒê√£ c·∫≠p nh·∫≠t y√™u c·∫ßu th·∫ª t√™n!"), NotificationType.Success)
                        Size: =FontSizes.Medium
                        Text: =If(varFormMode = "Create", "T·∫°o y√™u c·∫ßu", "C·∫≠p nh·∫≠t")
                        Width: =Parent.Width * 0.18
                        X: =Parent.Width * 0.78
                        Y: =Parent.Height * 0.2
      - Request.Details.Modal.Overlay:
          Control: Rectangle
          Properties:
            Fill: =Styles.Modal.Overlay
            Height: =Parent.Height
            OnSelect: |
              =Set(varShowRequestDetails, false)
            Visible: =varShowRequestDetails
            Width: =Parent.Width
      - Request.Details.Modal:
          Control: GroupContainer
          Variant: ManualLayout
          Properties:
            Fill: =Colors.White
            Height: =Parent.Height * 0.7
            Visible: =varShowRequestDetails
            Width: =Parent.Width * 0.5
            X: =If(varShowRequestDetails, (Parent.Width - Parent.Width * 0.5) / 2, -Parent.Width)
            Y: =If(varShowRequestDetails, (Parent.Height - Parent.Height * 0.7) / 2, -Parent.Height)
          Children:
            - Details.Modal.Header_1:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.Primary
                  Height: =Parent.Height * 0.12
                  Width: =Parent.Width
                Children:
                  - Details.Modal.Title_1:
                      Control: Label
                      Properties:
                        Color: =Colors.White
                        FontWeight: =FontWeight.Bold
                        Height: =Parent.Height
                        Size: =FontSizes.Large
                        Text: ="Chi ti·∫øt y√™u c·∫ßu th·∫ª t√™n"
                        Width: =Parent.Width * 0.8
                        X: =Parent.Width * 0.04
                  - Details.Modal.Close.Button_1:
                      Control: Classic/Button
                      Properties:
                        BorderColor: =Colors.White
                        Color: =Colors.White
                        Fill: =RGBA(0, 0, 0, 0)
                        Height: =Parent.Height * 0.6
                        OnSelect: |
                          =Set(varShowRequestDetails, false)
                        Size: =FontSizes.Large
                        Text: ="√ó"
                        Width: =Parent.Height * 0.6
                        X: =Parent.Width * 0.9
                        Y: =Parent.Height * 0.2
            - Details.Content:
                Control: GroupContainer
                Variant: ManualLayout
                Properties:
                  Fill: =Colors.White
                  Height: =Parent.Height * 0.88
                  Width: =Parent.Width
                  Y: =Parent.Height * 0.12
                Children:
                      - Details.Info.Container:
                          Control: GroupContainer
                          Variant: ManualLayout
                          Properties:
                            BorderColor: =Colors.BorderLight
                            BorderThickness: =1
                            Fill: =Colors.BackgroundLight
                            Height: =Parent.Height * 0.9
                            Width: =Parent.Width * 0.9
                            X: =Parent.Width * 0.05
                            Y: =Parent.Height * 0.05
                          Children:
                            - Request.ID.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  FontWeight: =FontWeight.Bold
                                  Height: =Parent.Height * 0.1
                                  Size: =FontSizes.Base
                                  Text: |
                                    =Concatenate("M√£ y√™u c·∫ßu: YC-", Text(varSelectedRequest.requestID, "000"))
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.05
                            - Quantity.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  Height: =Parent.Height * 0.08
                                  Size: =FontSizes.Base
                                  Text: =Concatenate("S·ªë l∆∞·ª£ng: ", Text(varSelectedRequest.quantity))
                                  Width: =Parent.Width * 0.45
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.18
                            - Status.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  Height: =Parent.Height * 0.08
                                  Size: =FontSizes.Base
                                  Text: =Concatenate("Tr·∫°ng th√°i: ", varSelectedRequest.status)
                                  Width: =Parent.Width * 0.45
                                  X: =Parent.Width * 0.5
                                  Y: =Parent.Height * 0.18
                            - SuggestedReason.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  Height: =Parent.Height * 0.15
                                  Size: =FontSizes.Base
                                  Text: =Concatenate("L√Ω do c·∫•p: ", varSelectedRequest.suggestedReason)
                                  VerticalAlign: =VerticalAlign.Top
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.28
                            - Notes.Label.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  FontWeight: =FontWeight.Semibold
                                  Height: =Parent.Height * 0.08
                                  Size: =FontSizes.Base
                                  Text: ="Ghi ch√∫:"
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.45
                            - Notes.Content.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextMuted
                                  Height: =Parent.Height * 0.15
                                  Size: =FontSizes.Base
                                  Text: =If(IsBlank(varSelectedRequest.note), "Kh√¥ng c√≥ ghi ch√∫", varSelectedRequest.note)
                                  VerticalAlign: =VerticalAlign.Top
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.53
                            - PrintNote.Label.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextPrimary
                                  FontWeight: =FontWeight.Semibold
                                  Height: =Parent.Height * 0.08
                                  Size: =FontSizes.Base
                                  Text: ="Ghi ch√∫ in ·∫•n:"
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.7
                            - PrintNote.Content.Detail:
                                Control: Label
                                Properties:
                                  Color: =Colors.TextMuted
                                  Height: =Parent.Height * 0.15
                                  Size: =FontSizes.Base
                                  Text: =If(IsBlank(varSelectedRequest.printNote), "Ch∆∞a c√≥ ghi ch√∫ in ·∫•n", varSelectedRequest.printNote)
                                  VerticalAlign: =VerticalAlign.Top
                                  Width: =Parent.Width * 0.9
                                  X: =Parent.Width * 0.05
                                  Y: =Parent.Height * 0.78
